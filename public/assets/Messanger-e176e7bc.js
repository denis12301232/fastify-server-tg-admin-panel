import{u as Je,a as Ke,Q as Me}from"./QDialog-eee8cc91.js";import{Q as U,R as j,p as Ze,m as et,n as tt,a as at}from"./QBtn-eca63939.js";import{Q as lt,c as nt,b as rt,a as st,d as ot,e as be,f as ut}from"./QLayout-ca727d94.js";import{c as it,Q as oe,b as Y,a as ct}from"./QCardSection-79a71e46.js";import{r as S,d as F,o as m,c as k,b as t,g as w,a2 as L,a3 as q,k as o,a4 as de,a1 as Q,a0 as H,_ as B,u as K,e as a,f as V,E as A,Q as O,a5 as dt,aG as ee,n as x,aH as G,ax as we,w as P,aa as X,a9 as Z,m as ue,q as C,ac as vt,ae as mt,af as _t,D as ft,X as ht,v as Ie,B as Le,aI as qe,p as ve,i as me,O as gt,l as Te,s as pt}from"./index-a6dc8171.js";import{Q as T,a as z}from"./selection-bbadb42a.js";import{Q as W}from"./QList-e3e94709.js";import{Q as te}from"./QInput-000adb20.js";import{b as R,Q as Qe}from"./QItemLabel-c980274b.js";import{u as N,a as Ve,b as De}from"./use-key-composition-071fe8ed.js";import{T as Ce}from"./TouchPan-41324eba.js";import{b as re}from"./format-7389883c.js";import{e as ie,s as Se}from"./scroll-4751b4b4.js";import{C as se}from"./ClosePopup-2e598289.js";import{Q as yt}from"./QLinearProgress-19150965.js";import{Q as Re}from"./QCardActions-65472d96.js";import"./use-prevent-scroll-f29c8a88.js";import"./use-timeout-4d28e583.js";import"./use-tick-8ab3fbd8.js";import"./focus-manager-e79c27be.js";import"./uid-6a237b22.js";class _e{static convertDay(n){return n<10?`0${n}`:n}static convertMonth(n){return n+1<10?`0${n+1}`:n+1}static convertYear(n){return n}static convertHours(n){return n<10?`0${n}`:n}static convertMinutes(n){return n<10?`0${n}`:n}static timeStruct(n){return{year:n.getFullYear(),month:n.getMonth(),day:n.getDate(),hours:n.getHours(),minutes:n.getMinutes()}}static showFilteredDate(n){const r=new Date,s=this.timeStruct(r),c=this.timeStruct(n);return s.year===c.year&&s.month===c.month&&s.day===c.day?`${this.convertHours(c.hours)}:${this.convertMinutes(c.minutes)}`:s.year===c.year?`${this.convertDay(c.day)}.${this.convertMonth(c.month)}`:`${this.convertDay(c.day)}.${this.convertMonth(c.month)}.${this.convertYear(c.year)}`}}function bt(){const e=S(null),n=S(null),r=S(null),s=S(!1);async function c(){e.value=await navigator.mediaDevices.getUserMedia({audio:!0}),n.value=new MediaRecorder(e.value,{audioBitsPerSecond:128e3}),n.value.onstart=()=>s.value=!s.value,n.value.onstop=()=>s.value=!s.value,n.value.ondataavailable=i=>{r.value=new File([i.data],"audio.ogg")},n.value.start()}function g(){var i,l,p;(i=n.value)==null||i.stop(),r.value=null,(p=(l=e.value)==null?void 0:l.getTracks().at(0))==null||p.stop()}return{mediaRecorder:n,isRecording:s,voiceMessage:r,startRecording:c,stopRecording:g}}const Ct=["src"],St=F({__name:"UserAvatar",props:{avatar:null,name:null,size:{default:"45px"},color:{default:"secondary"}},setup(e){return(n,r)=>(m(),k(it,{class:H(n.$style.avatar),size:e.size,color:e.color},{default:t(()=>[w(L(e.avatar?"":e.name.slice(0,1)),1),e.avatar?(m(),q("img",{key:0,src:`${o(de).SERVER_URL}/avatars/${e.avatar}`},null,8,Ct)):Q("",!0)]),_:1},8,["class","size","color"]))}}),kt="_avatar_1dacu_1",zt={avatar:kt},xt={$style:zt},J=B(St,[["__cssModules",xt]]),$t={class:"user_name"},Mt={class:"user_status"},wt=F({__name:"ChatLayout",emits:["openCreateGroup"],setup(e,{emit:n}){const r=K(),s=S(!1);function c(){s.value=!s.value}return(g,i)=>(m(),k(lt,{class:H(o(r).currentTheme==="dark"?"dark":"light"),view:"hHh lpR fFf"},{default:t(()=>[a(st,{class:"header",bordered:""},{default:t(()=>[a(nt,null,{default:t(()=>[a(U,{icon:"menu",dense:"",flat:"",round:"",onClick:c}),a(rt,null,{default:t(()=>[w("Мессенджер")]),_:1})]),_:1})]),_:1}),a(ct,{modelValue:s.value,"onUpdate:modelValue":i[1]||(i[1]=l=>s.value=l),side:"left",overlay:"",bordered:""},{default:t(()=>[a(W,{class:"list"},{default:t(()=>[a(oe,{class:"user_info",flat:"",square:""},{default:t(()=>[a(Y,null,{default:t(()=>[a(J,{name:o(r).user.name,avatar:o(r).user.avatar},null,8,["name","avatar"]),V("div",$t,L(o(r).user.name),1),V("div",Mt,L(o(r).user.status),1)]),_:1})]),_:1}),A((m(),k(T,{class:"list_item",clickable:"",tag:"a",to:"/","active-class":"active"},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(O,{name:"home"})]),_:1}),a(z,null,{default:t(()=>[w("На главную")]),_:1})]),_:1})),[[j]]),A((m(),k(T,{class:"list_item",clickable:"",tag:"a",to:"/account","active-class":"active"},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(O,{name:"account_circle"})]),_:1}),a(z,null,{default:t(()=>[w("Аккаунт")]),_:1})]),_:1})),[[j]]),A((m(),k(T,{class:"list_item",clickable:"","active-class":"active",onClick:i[0]||(i[0]=l=>[n("openCreateGroup"),c()])},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(O,{name:"note_add"})]),_:1}),a(z,null,{default:t(()=>[w("Создать группу")]),_:1})]),_:1})),[[j]])]),_:1})]),_:1},8,["modelValue"]),a(ot,{style:{height:"100vh"}},{default:t(()=>[dt(g.$slots,"default",{},void 0,!0)]),_:3})]),_:3},8,["class"]))}});const It=B(wt,[["__scopeId","data-v-3340b5b0"]]),Lt={class:"chats"},qt={key:0,class:"text-center"},Tt={key:0,class:"text-center"},Qt={style:{display:"flex","align-items":"center"}},Vt={key:0,class:"unread_count"},Dt=F({__name:"MessangerChatsList",props:{currentChatId:null,chats:null},setup(e){const n=K(),r=ee(),s=S(""),c=x(()=>r.chatsList.reduce((_,h)=>[..._,new Date(h.updatedAt)],[])),{f:g,data:i,loading:l}=N({fn:G.findUsers}),p=we.throttleDecorator(g,1e3);P(s,(_,h)=>{_?p(s.value):i.value=[]});async function $(_){const h=await G.createChat([n.user._id,_]),d=r.chatsList.find(u=>u._id===h.data._id);d?(r.currentChatId=d._id,r.onOpenChat(d._id)):(r.currentChatId=h.data._id,r.chatsList.push(h.data)),s.value=""}return(_,h)=>(m(),q("div",Lt,[a(te,{modelValue:s.value,"onUpdate:modelValue":h[0]||(h[0]=d=>s.value=d),label:"Поиск",outlined:"",dense:"",clearable:""},null,8,["modelValue"]),s.value?(m(),k(W,{key:0,class:"chats_list"},{default:t(()=>{var d;return[(d=o(i))!=null&&d.length?Q("",!0):(m(),q("h6",qt,"Ничего не найдено")),(m(!0),q(X,null,Z(o(i),u=>A((m(),k(T,{clickable:"",onClick:f=>$(u._id)},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(J,{name:u.name,avatar:u.avatar},null,8,["name","avatar"])]),_:2},1024),a(z,null,{default:t(()=>[w(L(u.name),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[j]])),256))]}),_:1})):(m(),k(W,{key:1,class:"chats_list"},{default:t(()=>{var d;return[(d=e.chats)!=null&&d.length?Q("",!0):(m(),q("h6",Tt,"Список диалогов пуст")),(m(!0),q(X,null,Z(e.chats,(u,f)=>A((m(),k(T,{class:"list_item",clickable:"","active-class":o(n).currentTheme==="dark"?"active_dark":"active_light",active:e.currentChatId===u._id,onClick:y=>o(r).onOpenChat(u._id)},{default:t(()=>[a(z,{avatar:""},{default:t(()=>{var y,M;return[a(J,{name:u.type==="dialog"?u.companion.name:((y=u.group)==null?void 0:y.title)||"",avatar:u.type==="dialog"?u.companion.avatar:((M=u.group)==null?void 0:M.avatar)||""},null,8,["name","avatar"])]}),_:2},1024),a(z,null,{default:t(()=>[a(R,null,{default:t(()=>{var y;return[w(L(u.type==="dialog"?u.companion.name:(y=u.group)==null?void 0:y.title),1)]}),_:2},1024),a(R,{caption:"",lines:"2"},{default:t(()=>{var y,M;return[w(L(u.messages.length?((M=(y=u==null?void 0:u.messages)==null?void 0:y.at(-1))==null?void 0:M.text)||"Аудиосообщение":"Еще нет сообщений"),1)]}),_:2},1024)]),_:2},1024),a(z,{side:"",top:"",bottom:""},{default:t(()=>[a(R,{caption:""},{default:t(()=>{var y,M,D;return[V("div",Qt,[u.type==="dialog"&&((M=(y=u.messages)==null?void 0:y.at(-1))==null?void 0:M.author)===o(n).user._id?(m(),k(O,{key:0,name:(D=u.messages.at(-1))!=null&&D.read.includes(u.companion._id)?"mdi-check-all":"mdi-check",style:{"padding-right":"5px"}},null,8,["name"])):Q("",!0),V("div",null,L(`${o(_e).showFilteredDate(o(c)[f])}`),1)]),+u.unread?(m(),q("div",Vt,[V("span",null,L(u.unread),1)])):Q("",!0)]}),_:2},1024)]),_:2},1024)]),_:2},1032,["active-class","active","onClick"])),[[j]])),256))]}),_:1}))]))}});const Rt=B(Dt,[["__scopeId","data-v-da21eddc"]]),Ue=ue({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:n}){const r=x(()=>e.sent===!0?"sent":"received"),s=x(()=>`q-message-text-content q-message-text-content--${r.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),c=x(()=>`q-message-text q-message-text--${r.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),g=x(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),i=x(()=>e.size!==void 0?`col-${e.size}`:""),l=x(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function p(_){return n.stamp!==void 0?[_,C("div",{class:"q-message-stamp"},n.stamp())]:e.stamp?[_,C("div",{class:"q-message-stamp",[l.value.stamp]:e.stamp})]:[_]}function $(_,h){const d=h===!0?_.length>1?u=>u:u=>C("div",[u]):u=>C("div",{[l.value.msg]:u});return _.map((u,f)=>C("div",{key:f,class:c.value},[C("div",{class:s.value},p(d(u)))]))}return()=>{const _=[];n.avatar!==void 0?_.push(n.avatar()):e.avatar!==void 0&&_.push(C("img",{class:`q-message-avatar q-message-avatar--${r.value}`,src:e.avatar,"aria-hidden":"true"}));const h=[];n.name!==void 0?h.push(C("div",{class:`q-message-name q-message-name--${r.value}`},n.name())):e.name!==void 0&&h.push(C("div",{class:`q-message-name q-message-name--${r.value}`,[l.value.name]:e.name})),n.default!==void 0?h.push($(Ze(n.default()),!0)):e.text!==void 0&&h.push($(e.text)),_.push(C("div",{class:i.value},h));const d=[];return n.label!==void 0?d.push(C("div",{class:"q-message-label"},n.label())):e.label!==void 0&&d.push(C("div",{class:"q-message-label",[l.value.label]:e.label})),d.push(C("div",{class:g.value},_)),C("div",{class:`q-message q-message-${r.value}`},d)}}}),ke=["vertical","horizontal"],ce={vertical:{offset:"offsetY",scroll:"scrollTop",dir:"down",dist:"y"},horizontal:{offset:"offsetX",scroll:"scrollLeft",dir:"right",dist:"x"}},ze={prevent:!0,mouse:!0,mouseAllDir:!0},xe=e=>e>=250?50:Math.ceil(e/5),Ae=ue({name:"QScrollArea",props:{...Ve,thumbStyle:Object,verticalThumbStyle:Object,horizontalThumbStyle:Object,barStyle:[Array,String,Object],verticalBarStyle:[Array,String,Object],horizontalBarStyle:[Array,String,Object],contentStyle:[Array,String,Object],contentActiveStyle:[Array,String,Object],delay:{type:[String,Number],default:1e3},visible:{type:Boolean,default:null},tabindex:[String,Number],onScroll:Function},setup(e,{slots:n,emit:r}){const s=S(!1),c=S(!1),g=S(!1),i={vertical:S(0),horizontal:S(0)},l={vertical:{ref:S(null),position:S(0),size:S(0)},horizontal:{ref:S(null),position:S(0),size:S(0)}},{proxy:p}=Ie(),$=De(e,p.$q);let _=null,h;const d=S(null),u=x(()=>"q-scrollarea"+($.value===!0?" q-scrollarea--dark":""));l.vertical.percentage=x(()=>{const v=l.vertical.size.value-i.vertical.value;if(v<=0)return 0;const b=re(l.vertical.position.value/v,0,1);return Math.round(b*1e4)/1e4}),l.vertical.thumbHidden=x(()=>(e.visible===null?g.value:e.visible)!==!0&&s.value===!1&&c.value===!1||l.vertical.size.value<=i.vertical.value+1),l.vertical.thumbStart=x(()=>l.vertical.percentage.value*(i.vertical.value-l.vertical.thumbSize.value)),l.vertical.thumbSize=x(()=>Math.round(re(i.vertical.value*i.vertical.value/l.vertical.size.value,xe(i.vertical.value),i.vertical.value))),l.vertical.style=x(()=>({...e.thumbStyle,...e.verticalThumbStyle,top:`${l.vertical.thumbStart.value}px`,height:`${l.vertical.thumbSize.value}px`})),l.vertical.thumbClass=x(()=>"q-scrollarea__thumb q-scrollarea__thumb--v absolute-right"+(l.vertical.thumbHidden.value===!0?" q-scrollarea__thumb--invisible":"")),l.vertical.barClass=x(()=>"q-scrollarea__bar q-scrollarea__bar--v absolute-right"+(l.vertical.thumbHidden.value===!0?" q-scrollarea__bar--invisible":"")),l.horizontal.percentage=x(()=>{const v=l.horizontal.size.value-i.horizontal.value;if(v<=0)return 0;const b=re(Math.abs(l.horizontal.position.value)/v,0,1);return Math.round(b*1e4)/1e4}),l.horizontal.thumbHidden=x(()=>(e.visible===null?g.value:e.visible)!==!0&&s.value===!1&&c.value===!1||l.horizontal.size.value<=i.horizontal.value+1),l.horizontal.thumbStart=x(()=>l.horizontal.percentage.value*(i.horizontal.value-l.horizontal.thumbSize.value)),l.horizontal.thumbSize=x(()=>Math.round(re(i.horizontal.value*i.horizontal.value/l.horizontal.size.value,xe(i.horizontal.value),i.horizontal.value))),l.horizontal.style=x(()=>({...e.thumbStyle,...e.horizontalThumbStyle,[p.$q.lang.rtl===!0?"right":"left"]:`${l.horizontal.thumbStart.value}px`,width:`${l.horizontal.thumbSize.value}px`})),l.horizontal.thumbClass=x(()=>"q-scrollarea__thumb q-scrollarea__thumb--h absolute-bottom"+(l.horizontal.thumbHidden.value===!0?" q-scrollarea__thumb--invisible":"")),l.horizontal.barClass=x(()=>"q-scrollarea__bar q-scrollarea__bar--h absolute-bottom"+(l.horizontal.thumbHidden.value===!0?" q-scrollarea__bar--invisible":""));const f=x(()=>l.vertical.thumbHidden.value===!0&&l.horizontal.thumbHidden.value===!0?e.contentStyle:e.contentActiveStyle),y=[[Ce,v=>{ge(v,"vertical")},void 0,{vertical:!0,...ze}]],M=[[Ce,v=>{ge(v,"horizontal")},void 0,{horizontal:!0,...ze}]];function D(){const v={};return ke.forEach(b=>{const I=l[b];v[b+"Position"]=I.position.value,v[b+"Percentage"]=I.percentage.value,v[b+"Size"]=I.size.value,v[b+"ContainerSize"]=i[b].value}),v}const fe=vt(()=>{const v=D();v.ref=p,r("scroll",v)},0);function he(v,b,I){if(ke.includes(v)===!1){console.error("[QScrollArea]: wrong first param of setScrollPosition (vertical/horizontal)");return}(v==="vertical"?Se:ie)(d.value,b,I)}function Ge({height:v,width:b}){let I=!1;i.vertical.value!==v&&(i.vertical.value=v,I=!0),i.horizontal.value!==b&&(i.horizontal.value=b,I=!0),I===!0&&ae()}function Fe({position:v}){let b=!1;l.vertical.position.value!==v.top&&(l.vertical.position.value=v.top,b=!0),l.horizontal.position.value!==v.left&&(l.horizontal.position.value=v.left,b=!0),b===!0&&ae()}function Be({height:v,width:b}){l.horizontal.size.value!==b&&(l.horizontal.size.value=b,ae()),l.vertical.size.value!==v&&(l.vertical.size.value=v,ae())}function ge(v,b){const I=l[b];if(v.isFirst===!0){if(I.thumbHidden.value===!0)return;h=I.position.value,c.value=!0}else if(c.value!==!0)return;v.isFinal===!0&&(c.value=!1);const E=ce[b],ne=i[b].value,Ye=(I.size.value-ne)/(ne-I.thumbSize.value),Xe=v.distance[E.dist],We=h+(v.direction===E.dir?1:-1)*Xe*Ye;ye(We,b)}function pe(v,b){const I=l[b];if(I.thumbHidden.value!==!0){const E=v[ce[b].offset];if(E<I.thumbStart.value||E>I.thumbStart.value+I.thumbSize.value){const ne=E-I.thumbSize.value/2;ye(ne/i[b].value*I.size.value,b)}I.ref.value!==null&&I.ref.value.dispatchEvent(new MouseEvent(v.type,v))}}function Oe(v){pe(v,"vertical")}function je(v){pe(v,"horizontal")}function ae(){s.value=!0,_!==null&&clearTimeout(_),_=setTimeout(()=>{_=null,s.value=!1},e.delay),e.onScroll!==void 0&&fe()}function ye(v,b){d.value[ce[b].scroll]=v}function Ne(){g.value=!0}function Ee(){g.value=!1}let le=null;return P(()=>p.$q.lang.rtl,v=>{d.value!==null&&ie(d.value,Math.abs(l.horizontal.position.value)*(v===!0?-1:1))}),mt(()=>{le={top:l.vertical.position.value,left:l.horizontal.position.value}}),_t(()=>{if(le===null)return;const v=d.value;v!==null&&(ie(v,le.left),Se(v,le.top))}),ft(fe.cancel),Object.assign(p,{getScrollTarget:()=>d.value,getScroll:D,getScrollPosition:()=>({top:l.vertical.position.value,left:l.horizontal.position.value}),getScrollPercentage:()=>({top:l.vertical.percentage.value,left:l.horizontal.percentage.value}),setScrollPosition:he,setScrollPercentage(v,b,I){he(v,b*(l[v].size.value-i[v].value)*(v==="horizontal"&&p.$q.lang.rtl===!0?-1:1),I)}}),()=>C("div",{class:u.value,onMouseenter:Ne,onMouseleave:Ee},[C("div",{ref:d,class:"q-scrollarea__container scroll relative-position fit hide-scrollbar",tabindex:e.tabindex!==void 0?e.tabindex:void 0},[C("div",{class:"q-scrollarea__content absolute",style:f.value},ht(n.default,[C(be,{debounce:0,onResize:Be})])),C(ut,{axis:"both",onScroll:Fe})]),C(be,{debounce:0,onResize:Ge}),C("div",{class:l.vertical.barClass.value,style:[e.barStyle,e.verticalBarStyle],"aria-hidden":"true",onMousedown:Oe}),C("div",{class:l.horizontal.barClass.value,style:[e.barStyle,e.horizontalBarStyle],"aria-hidden":"true",onMousedown:je}),A(C("div",{ref:l.vertical.ref,class:l.vertical.thumbClass.value,style:l.vertical.style.value,"aria-hidden":"true"}),y),A(C("div",{ref:l.horizontal.ref,class:l.horizontal.thumbClass.value,style:l.horizontal.style.value,"aria-hidden":"true"}),M)])}}),Ut={key:0},At={key:1},Ht={key:2,class:"recording"},Pt=F({__name:"MessangerInput",setup(e){const n=ee(),r=S(""),s=S(null),c=S(null),{voiceMessage:g,isRecording:i,startRecording:l,stopRecording:p}=bt(),{f:$,data:_,loading:h}=N({fn:()=>G.saveMessage(n.currentChatId,r.value)}),{f:d,data:u,loading:f}=N({fn:()=>G.saveAudioMessage(c.value,n.currentChatId)});return P(g,()=>{g.value&&(c.value=new FormData,c.value.append("audio",g.value))}),P([_,u],(y,M)=>{y[0]&&y[0]!==M[0]&&(n.currentChat.messages.push(y[0]),n.currentChat.updatedAt=y[0].createdAt,r.value=""),y[1]&&y[1]!==M[1]&&(n.currentChat.messages.push(y[1]),n.currentChat.updatedAt=y[1].createdAt,c.value=null)}),P(i,()=>{var y;(y=s.value)==null||y.blur()}),P(c,()=>{console.log(c.value),console.log(Boolean(c.value))}),(y,M)=>(m(),k(te,{class:"input",modelValue:r.value,"onUpdate:modelValue":M[3]||(M[3]=D=>r.value=D),ref_key:"inputRef",ref:s,outlined:"","label-slot":"",loading:o(h)||o(f),readonly:o(i)},{label:t(()=>[c.value?(m(),q("div",Ut,"Записано голосовое сообщение")):o(i)?(m(),q("div",Ht,"Идет запись... ")):(m(),q("div",At,"Написать сообщение"))]),append:t(()=>[c.value?(m(),k(U,{key:0,dense:"",round:"",flat:"",icon:"stop_circle",color:"red",onClick:M[0]||(M[0]=D=>c.value=null)})):Q("",!0),a(U,{dense:"",round:"",flat:"",icon:o(i)?"mic_off":"mic",onClick:M[1]||(M[1]=D=>o(i)?o(p)():o(l)())},null,8,["icon"]),a(U,{dense:"",round:"",flat:"",icon:"send",disable:o(h)||o(f),onClick:M[2]||(M[2]=D=>c.value?o(d)():o($)())},null,8,["disable"])]),_:1},8,["modelValue","loading","readonly"]))}});const He=B(Pt,[["__scopeId","data-v-01e17523"]]),Gt=["src"],Ft=F({__name:"MessangerVoiceMessage",props:{src:null},setup(e){const n=S(null),r=S(!1),s=S(0),c=S(0),g=S(0);Le(()=>{n.value&&(n.value.onplay=()=>r.value=!0,n.value.onpause=()=>r.value=!1,n.value.ontimeupdate=l=>{const p=l.target;g.value=(p.duration/100).toFixed(2).replace(".",":"),c.value=(p.currentTime/100).toFixed(2).replace(".",":"),s.value=Math.round(p.currentTime*100/p.duration)/100},n.value.onended=()=>s.value=0)});function i(){var l,p;r.value?(l=n.value)==null||l.pause():(p=n.value)==null||p.play()}return(l,p)=>(m(),q(X,null,[V("audio",{ref_key:"audio",ref:n,src:e.src,preload:"metadata",volume:1},null,8,Gt),V("div",{class:H(l.$style.audio)},[a(O,{name:r.value?"stop_circle":"play_circle",onClick:i,size:"40px",color:"white"},null,8,["name"]),V("div",{class:H(l.$style.audio_info)},[a(yt,{value:s.value,"instant-feedback":"",color:"pink",class:H(l.$style.audio_progress)},null,8,["value","class"]),c.value&&g.value?(m(),q("div",{key:0,class:H(l.$style.audio_time)},L(c.value+" / "+g.value),3)):Q("",!0)],2)],2)],64))}}),Bt="_audio_16ywe_1",Ot="_audio_info_16ywe_9",jt="_audio_time_16ywe_12",Nt="_audio_progress_16ywe_16",Et={audio:Bt,audio_info:Ot,audio_time:jt,audio_progress:Nt},Yt={$style:Et},Pe=B(Ft,[["__cssModules",Yt]]),Xt={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Wt={style:{padding:"0 10px 0 0"}},Jt=F({__name:"MessangerDialog",props:{currentChatId:null,currentChat:null},setup(e){const n=e,r=K(),s=ee(),c=S(null),g=x(()=>n.currentChat.messages),i=x(()=>g.value.reduce((p,$)=>[...p,new Date($.createdAt)],[]));P(g,()=>{setTimeout(()=>{var $,_;const p=($=c.value)==null?void 0:$.getScroll();(_=c.value)==null||_.setScrollPosition("vertical",(p==null?void 0:p.verticalSize)||0)},0)},{deep:!0,immediate:!0});async function l(){await G.deleteChat(n.currentChatId),s.chatsList=s.chatsList.filter(p=>p._id!==n.currentChatId),s.currentChatId=""}return(p,$)=>(m(),q("div",{class:H(["dialog",o(r).currentTheme==="dark"?"dialog_dark":"dialog_light"])},[a(T,{class:"dialog_name"},{default:t(()=>[a(z,{class:"back",avatar:""},{default:t(()=>[a(U,{dense:"",round:"",flat:"",icon:"arrow_back",color:"primary",onClick:$[0]||($[0]=_=>o(s).currentChatId="")})]),_:1}),a(z,null,{default:t(()=>[a(R,{class:"text-h6"},{default:t(()=>[w(L(e.currentChat.companion.name),1)]),_:1}),a(R,{caption:""},{default:t(()=>[w(L(e.currentChat.companion.status),1)]),_:1})]),_:1}),a(z,{side:""},{default:t(()=>[a(U,{icon:"more_vert",round:"",dense:"",flat:"",color:"primary"},{default:t(()=>[a(Qe,null,{default:t(()=>[a(W,{bordered:""},{default:t(()=>[A((m(),k(T,{class:"text-red",clickable:"",onClick:l},{default:t(()=>[a(z,{avatar:"",style:{"padding-right":"10px","min-width":"0"}},{default:t(()=>[a(O,{name:"delete"})]),_:1}),a(z,null,{default:t(()=>[w("Удалить чат")]),_:1})]),_:1})),[[j],[se]])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(Ae,{class:"dialog_content",delay:"1200",ref_key:"dialogRef",ref:c},{default:t(()=>[(m(!0),q(X,null,Z(o(g),(_,h)=>{var d;return m(),k(Ue,{text:[_.text],sent:_.author===o(r).user._id,key:_._id,style:{padding:"0 20px"},"bg-color":_.author===o(r).user._id?"primary":"teal","text-color":"white"},qe({stamp:t(()=>[V("div",Xt,[V("div",Wt,L(o(_e).showFilteredDate(o(i)[h])),1),_.author===o(r).user._id?(m(),k(O,{key:0,name:_.read.includes(e.currentChat.companion._id)?"mdi-check-all":"mdi-check"},null,8,["name"])):Q("",!0)])]),_:2},[((d=_.attachments.at(0))==null?void 0:d.type)==="audio"?{name:"default",fn:t(()=>{var u;return[a(Pe,{src:`${o(de).SERVER_URL}/audio/${(u=_.attachments.at(0))==null?void 0:u.name}`},null,8,["src"])]}),key:"0"}:void 0]),1032,["text","sent","bg-color"])}),128))]),_:1},512),e.currentChatId?(m(),k(He,{key:0,style:{margin:"5px"}})):Q("",!0)],2))}});const $e=B(Jt,[["__scopeId","data-v-0e3a8c22"]]),Kt=e=>(ve("data-v-4b1506dd"),e=e(),me(),e),Zt=Kt(()=>V("div",{class:"title text-h6 text-center"},"Добавить в группу",-1)),ea={key:0,class:"text-center"},ta=F({__name:"MessangerGroupAddUser",props:{chat_id:null},setup(e){const n=e,r=S(""),s=S(null),{f:c,data:g,loading:i}=N({fn:G.findUsers}),l=we.throttleDecorator(c,1e3),{f:p,loading:$}=N({fn:()=>{var h;return G.addUserToGroup(n.chat_id,(h=s.value)==null?void 0:h._id)},successMsg:"Пользователь добавлен в чат",alert:!0});P(r,(h,d)=>{h?(l(r.value),s.value=null):g.value=[]});function _(h){s.value=h,r.value=""}return(h,d)=>(m(),k(oe,{class:"add"},{default:t(()=>[a(Y,null,{default:t(()=>[Zt,a(te,{modelValue:r.value,"onUpdate:modelValue":d[0]||(d[0]=u=>r.value=u),outlined:"",loading:o(i),label:"Имя или логин",clearable:""},null,8,["modelValue","loading"])]),_:1}),a(Y,{style:{padding:"0"}},{default:t(()=>{var u;return[a(W,null,{default:t(()=>[s.value?(m(),k(T,{key:1,"active-class":"active",active:!!s.value,clickable:"",onClick:d[1]||(d[1]=f=>s.value=null)},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(J,{name:s.value.name,avatar:s.value.avatar},null,8,["name","avatar"])]),_:1}),a(z,{side:""},{default:t(()=>[a(R,null,{default:t(()=>[w(L(s.value.name),1)]),_:1}),a(R,null,{default:t(()=>[w(L(s.value.login),1)]),_:1})]),_:1})]),_:1},8,["active"])):(m(!0),q(X,{key:0},Z(o(g),f=>A((m(),k(T,{clickable:"",onClick:y=>_(f)},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(J,{name:f.name,avatar:f.avatar},null,8,["name","avatar"])]),_:2},1024),a(z,{side:""},{default:t(()=>[a(R,null,{default:t(()=>[w(L(f.name),1)]),_:2},1024),a(R,null,{default:t(()=>[w(L(f.login),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[j]])),256))]),_:1}),!((u=o(g))!=null&&u.length)&&r.value?(m(),q("div",ea,"Не найдено ни одного человека")):Q("",!0)]}),_:1}),a(Re,{align:"center"},{default:t(()=>[A((m(),k(U,{color:"primary",disable:!s.value,loading:o($),onClick:o(p)},{default:t(()=>[w("Добавить")]),_:1},8,["disable","loading","onClick"])),[[se]])]),_:1})]),_:1}))}});const aa=B(ta,[["__scopeId","data-v-4b1506dd"]]),la=[C("g",{transform:"translate(-20,-20)"},[C("path",{d:"M79.9,52.6C80,51.8,80,50.9,80,50s0-1.8-0.1-2.6l-5.1-0.4c-0.3-2.4-0.9-4.6-1.8-6.7l4.2-2.9c-0.7-1.6-1.6-3.1-2.6-4.5 L70,35c-1.4-1.9-3.1-3.5-4.9-4.9l2.2-4.6c-1.4-1-2.9-1.9-4.5-2.6L59.8,27c-2.1-0.9-4.4-1.5-6.7-1.8l-0.4-5.1C51.8,20,50.9,20,50,20 s-1.8,0-2.6,0.1l-0.4,5.1c-2.4,0.3-4.6,0.9-6.7,1.8l-2.9-4.1c-1.6,0.7-3.1,1.6-4.5,2.6l2.1,4.6c-1.9,1.4-3.5,3.1-5,4.9l-4.5-2.1 c-1,1.4-1.9,2.9-2.6,4.5l4.1,2.9c-0.9,2.1-1.5,4.4-1.8,6.8l-5,0.4C20,48.2,20,49.1,20,50s0,1.8,0.1,2.6l5,0.4 c0.3,2.4,0.9,4.7,1.8,6.8l-4.1,2.9c0.7,1.6,1.6,3.1,2.6,4.5l4.5-2.1c1.4,1.9,3.1,3.5,5,4.9l-2.1,4.6c1.4,1,2.9,1.9,4.5,2.6l2.9-4.1 c2.1,0.9,4.4,1.5,6.7,1.8l0.4,5.1C48.2,80,49.1,80,50,80s1.8,0,2.6-0.1l0.4-5.1c2.3-0.3,4.6-0.9,6.7-1.8l2.9,4.2 c1.6-0.7,3.1-1.6,4.5-2.6L65,69.9c1.9-1.4,3.5-3,4.9-4.9l4.6,2.2c1-1.4,1.9-2.9,2.6-4.5L73,59.8c0.9-2.1,1.5-4.4,1.8-6.7L79.9,52.6 z M50,65c-8.3,0-15-6.7-15-15c0-8.3,6.7-15,15-15s15,6.7,15,15C65,58.3,58.3,65,50,65z",fill:"currentColor"},[C("animateTransform",{attributeName:"transform",type:"rotate",from:"90 50 50",to:"0 50 50",dur:"1s",repeatCount:"indefinite"})])]),C("g",{transform:"translate(20,20) rotate(15 50 50)"},[C("path",{d:"M79.9,52.6C80,51.8,80,50.9,80,50s0-1.8-0.1-2.6l-5.1-0.4c-0.3-2.4-0.9-4.6-1.8-6.7l4.2-2.9c-0.7-1.6-1.6-3.1-2.6-4.5 L70,35c-1.4-1.9-3.1-3.5-4.9-4.9l2.2-4.6c-1.4-1-2.9-1.9-4.5-2.6L59.8,27c-2.1-0.9-4.4-1.5-6.7-1.8l-0.4-5.1C51.8,20,50.9,20,50,20 s-1.8,0-2.6,0.1l-0.4,5.1c-2.4,0.3-4.6,0.9-6.7,1.8l-2.9-4.1c-1.6,0.7-3.1,1.6-4.5,2.6l2.1,4.6c-1.9,1.4-3.5,3.1-5,4.9l-4.5-2.1 c-1,1.4-1.9,2.9-2.6,4.5l4.1,2.9c-0.9,2.1-1.5,4.4-1.8,6.8l-5,0.4C20,48.2,20,49.1,20,50s0,1.8,0.1,2.6l5,0.4 c0.3,2.4,0.9,4.7,1.8,6.8l-4.1,2.9c0.7,1.6,1.6,3.1,2.6,4.5l4.5-2.1c1.4,1.9,3.1,3.5,5,4.9l-2.1,4.6c1.4,1,2.9,1.9,4.5,2.6l2.9-4.1 c2.1,0.9,4.4,1.5,6.7,1.8l0.4,5.1C48.2,80,49.1,80,50,80s1.8,0,2.6-0.1l0.4-5.1c2.3-0.3,4.6-0.9,6.7-1.8l2.9,4.2 c1.6-0.7,3.1-1.6,4.5-2.6L65,69.9c1.9-1.4,3.5-3,4.9-4.9l4.6,2.2c1-1.4,1.9-2.9,2.6-4.5L73,59.8c0.9-2.1,1.5-4.4,1.8-6.7L79.9,52.6 z M50,65c-8.3,0-15-6.7-15-15c0-8.3,6.7-15,15-15s15,6.7,15,15C65,58.3,58.3,65,50,65z",fill:"currentColor"},[C("animateTransform",{attributeName:"transform",type:"rotate",from:"0 50 50",to:"90 50 50",dur:"1s",repeatCount:"indefinite"})])])],na=ue({name:"QSpinnerGears",props:et,setup(e){const{cSize:n,classes:r}=tt(e);return()=>C("svg",{class:r.value,width:n.value,height:n.value,viewBox:"0 0 100 100",preserveAspectRatio:"xMidYMid",xmlns:"http://www.w3.org/2000/svg"},la)}}),ra=ue({name:"QInnerLoading",props:{...Ve,...Je,showing:Boolean,color:String,size:{type:[String,Number],default:42},label:String,labelClass:String,labelStyle:[String,Array,Object]},setup(e,{slots:n}){const r=Ie(),s=De(e,r.proxy.$q),{transitionProps:c,transitionStyle:g}=Ke(e),i=x(()=>"q-inner-loading absolute-full column flex-center"+(s.value===!0?" q-inner-loading--dark":"")),l=x(()=>"q-inner-loading__label"+(e.labelClass!==void 0?` ${e.labelClass}`:""));function p(){const _=[C(at,{size:e.size,color:e.color})];return e.label!==void 0&&_.push(C("div",{class:l.value,style:e.labelStyle},[e.label])),_}function $(){return e.showing===!0?C("div",{class:i.value,style:g.value},n.default!==void 0?n.default():p()):null}return()=>C(gt,c.value,$)}}),sa=e=>(ve("data-v-2001a1c3"),e=e(),me(),e),oa=sa(()=>V("div",{class:"title text-h5 text-center"},"Информация о группе",-1)),ua=F({__name:"MessangerGroupInfo",props:{avatar:null,name:null,chat_id:null,users_count:null,roles:null},setup(e){const n=e,r=K(),s=S(""),{f:c,loading:g,data:i}=N({fn:G.getUsersListInChat}),{f:l,loading:p}=N({fn:h=>{var d;G.removeUserFromGroup(n.chat_id,h),i.value=(d=i.value)==null?void 0:d.filter(u=>u._id!==h)}}),$=x(()=>{var h;return(h=i.value)==null?void 0:h.filter(d=>d.name.includes(s.value)||d.login.includes(s.value))}),_=x(()=>{var h,d;return!!((h=n.roles.creator)!=null&&h.includes(r.user._id)||(d=n.roles.admin)!=null&&d.includes(r.user._id))});return Le(()=>c(n.chat_id)),(h,d)=>(m(),k(oe,{class:"info"},{default:t(()=>[a(Y,null,{default:t(()=>[oa]),_:1}),a(Y,null,{default:t(()=>[a(T,null,{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(J,{avatar:e.avatar,name:e.name},null,8,["avatar","name"])]),_:1}),a(z,null,{default:t(()=>[a(R,{class:"text-h5"},{default:t(()=>[w(L(e.name),1)]),_:1}),a(R,{caption:""},{default:t(()=>[w(L(e.users_count)+" участников",1)]),_:1})]),_:1})]),_:1})]),_:1}),a(Y,null,{default:t(()=>[a(T,null,{default:t(()=>[a(z,{class:"text-center text-h6 q-mb-sm"},{default:t(()=>[w("Список участников")]),_:1})]),_:1}),a(te,{class:"q-mb-sm",modelValue:s.value,"onUpdate:modelValue":d[0]||(d[0]=u=>s.value=u),label:"Найти",outlined:"",dense:""},null,8,["modelValue"]),o(g)?(m(),k(T,{key:0},{default:t(()=>[a(ra,{showing:o(g)},{default:t(()=>[a(na,{size:"50px",color:"primary"})]),_:1},8,["showing"])]),_:1})):Q("",!0),a(W,null,{default:t(()=>{var u;return[(m(!0),q(X,null,Z(o($),f=>(m(),k(T,{key:f._id},{default:t(()=>[a(z,{avatar:""},{default:t(()=>[a(J,{name:f.name||"",avatar:f.avatar||""},null,8,["name","avatar"])]),_:2},1024),a(z,null,{default:t(()=>[w(L(f.name),1)]),_:2},1024),o(_)&&f._id!==o(r).user._id?(m(),k(z,{key:0,side:""},{default:t(()=>[a(U,{dense:"",flat:"",round:"",icon:"delete",loading:o(p),onClick:y=>o(l)(f._id)},null,8,["loading","onClick"])]),_:2},1024)):Q("",!0)]),_:2},1024))),128)),!o(g)&&!((u=o($))!=null&&u.length)?(m(),k(T,{key:0},{default:t(()=>[a(z,{class:"text-center"},{default:t(()=>[w("Ничего не найдено")]),_:1})]),_:1})):Q("",!0)]}),_:1})]),_:1})]),_:1}))}});const ia=B(ua,[["__scopeId","data-v-2001a1c3"]]),ca={style:{display:"flex","justify-content":"space-between","align-items":"center"}},da={style:{padding:"0 10px 0 0"}},va=F({__name:"MessangerGroup",props:{currentChatId:null,currentChat:null},setup(e){const n=e,r=K(),s=ee(),c=S("add_user"),g=S(null),i=S(!1),l=x(()=>n.currentChat.messages),p=x(()=>l.value.reduce((d,u)=>[...d,new Date(u.createdAt)],[])),$=x(()=>{switch(c.value){case"add_user":return aa;case"info":return ia}});P(l,()=>{setTimeout(()=>{var u,f;const d=(u=g.value)==null?void 0:u.getScroll();(f=g.value)==null||f.setScrollPosition("vertical",(d==null?void 0:d.verticalSize)||0)},0)},{deep:!0,immediate:!0});function _(d){c.value=d,i.value=!i.value}async function h(){await G.leaveChat(n.currentChatId),s.chatsList=s.chatsList.filter(d=>d._id!==n.currentChatId),s.currentChatId=""}return(d,u)=>(m(),q("div",{class:H(["group",o(r).currentTheme==="dark"?"group_dark":"group_light"])},[a(Me,{modelValue:i.value,"onUpdate:modelValue":u[0]||(u[0]=f=>i.value=f)},{default:t(()=>{var f,y,M;return[(m(),k(Te(o($)),{chat_id:e.currentChatId,avatar:(f=e.currentChat.group)==null?void 0:f.avatar,name:(y=e.currentChat.group)==null?void 0:y.title,users_count:e.currentChat.users.length,roles:(M=e.currentChat.group)==null?void 0:M.roles},null,8,["chat_id","avatar","name","users_count","roles"]))]}),_:1},8,["modelValue"]),a(T,{class:"group_title"},{default:t(()=>[a(z,{class:"back",avatar:""},{default:t(()=>[a(U,{icon:"arrow_back",color:"primary",dense:"",round:"",flat:"",onClick:u[1]||(u[1]=f=>o(s).currentChatId="")})]),_:1}),a(z,null,{default:t(()=>[a(R,{class:"text-h6"},{default:t(()=>{var f;return[w(L((f=e.currentChat.group)==null?void 0:f.title),1)]}),_:1}),a(R,{caption:""},{default:t(()=>[w(L(e.currentChat.users.length)+" участников ",1)]),_:1})]),_:1}),a(z,{side:"",style:{display:"flex","flex-direction":"row","align-items":"center","justify-content":"center"}},{default:t(()=>{var f;return[(f=o(s).currentChat.group)!=null&&f.roles.creator.includes(o(r).user._id)?(m(),k(U,{key:0,icon:"person_add",color:"primary",dense:"",round:"",flat:"",onClick:u[2]||(u[2]=y=>_("add_user"))})):Q("",!0),a(U,{icon:"more_vert",round:"",dense:"",flat:"",color:"primary"},{default:t(()=>[a(Qe,null,{default:t(()=>[a(W,{bordered:""},{default:t(()=>[A((m(),k(T,{clickable:"",onClick:u[3]||(u[3]=y=>_("info"))},{default:t(()=>[a(z,{avatar:"",style:{"padding-right":"10px","min-width":"0"}},{default:t(()=>[a(O,{name:"info"})]),_:1}),a(z,null,{default:t(()=>[w("Информация о группе")]),_:1})]),_:1})),[[j],[se]]),A((m(),k(T,{class:"text-red",clickable:"",onClick:h},{default:t(()=>[a(z,{avatar:"",style:{"padding-right":"10px","min-width":"0"}},{default:t(()=>[a(O,{name:"logout"})]),_:1}),a(z,null,{default:t(()=>[w("Покинуть группу")]),_:1})]),_:1})),[[j],[se]])]),_:1})]),_:1})]),_:1})]}),_:1})]),_:1}),a(Ae,{class:"group_content",delay:"1200",ref_key:"dialogRef",ref:g},{default:t(()=>[(m(!0),q(X,null,Z(o(l),(f,y)=>{var M;return m(),k(Ue,{text:[f.text],sent:f.author===o(r).user._id,key:f._id,style:{padding:"0 20px"},"bg-color":f.author===o(r).user._id?"primary":"seconary","text-color":"white"},qe({name:t(()=>[w(L(f.author===o(r).user._id?"Я":e.currentChat.users.filter(D=>D._id===f.author)[0].name),1)]),stamp:t(()=>[V("div",ca,[V("div",da,L(o(_e).showFilteredDate(o(p)[y])),1),f.author===o(r).user._id?(m(),k(O,{key:0,name:f.read.length>1?"mdi-check-all":"mdi-check"},null,8,["name"])):Q("",!0)])]),_:2},[((M=f.attachments[0])==null?void 0:M.type)==="audio"?{name:"default",fn:t(()=>{var D;return[a(Pe,{src:`${o(de).SERVER_URL}/audio/${(D=f.attachments[0])==null?void 0:D.name}`},null,8,["src"])]}),key:"0"}:void 0]),1032,["text","sent","bg-color"])}),128))]),_:1},512),e.currentChatId?(m(),k(He,{key:0,style:{margin:"5px"}})):Q("",!0)],2))}});const ma=B(va,[["__scopeId","data-v-7798da5f"]]),_a=e=>(ve("data-v-a70283c5"),e=e(),me(),e),fa=_a(()=>V("div",{class:"text-h5 text-center q-pb-lg"},"Создать группу",-1)),ha=F({__name:"MessangerFormCreateGroup",emits:["close"],setup(e,{emit:n}){const r=K(),s=ee(),c=S(""),{f:g,loading:i,data:l}=N({fn:()=>G.createGroup([r.user._id],c.value)});return P(l,()=>{l.value&&s.chatsList.push(l.value),n("close")}),(p,$)=>(m(),k(oe,{class:"content"},{default:t(()=>[a(Y,null,{default:t(()=>[fa,a(te,{modelValue:c.value,"onUpdate:modelValue":$[0]||($[0]=_=>c.value=_),outlined:"",label:"Название"},null,8,["modelValue"])]),_:1}),a(Re,{align:"center"},{default:t(()=>[a(U,{color:"primary",loading:o(i),onClick:o(g)},{default:t(()=>[w("Создать")]),_:1},8,["loading","onClick"])]),_:1})]),_:1}))}});const ga=B(ha,[["__scopeId","data-v-a70283c5"]]),pa={class:"container"},ya=F({__name:"Messanger",setup(e){K();const n=ee(),r=S(!1),s=pt($e);P(()=>n.currentChat.type,(g,i)=>{switch(g){case"dialog":s.value=$e;break;case"group":s.value=ma;break}});function c(){r.value=!r.value}return(g,i)=>(m(),k(It,{onOpenCreateGroup:c},{default:t(()=>[V("div",pa,[a(Me,{modelValue:r.value,"onUpdate:modelValue":i[0]||(i[0]=l=>r.value=l)},{default:t(()=>[a(ga,{onClose:c})]),_:1},8,["modelValue"]),a(Rt,{"current-chat-id":o(n).currentChatId,chats:o(n).chatsList,class:H(o(n).currentChatId?"hide":"not_hide")},null,8,["current-chat-id","chats","class"]),o(n).currentChatId?(m(),k(Te(o(s)),{key:1,"current-chat-id":o(n).currentChatId,"current-chat":o(n).currentChat,class:H(o(n).currentChatId?"not_hide":"hide")},null,8,["current-chat-id","current-chat","class"])):(m(),q("div",{key:0,class:H(["dialog_not_selected",o(n).currentChatId?"not_hide":"hide"])},"Выберите, кому вы бы хотели написать",2))])]),_:1}))}});const Ga=B(ya,[["__scopeId","data-v-41f474d9"]]);export{Ga as default};
