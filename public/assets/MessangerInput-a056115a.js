import{Q as m}from"./QBtn-84d97db2.js";import{Q as V}from"./QInput-f9d1dd50.js";import{r,d as A,aG as B,aH as C,w as f,o as d,c as y,b as R,a3 as _,k as o,a1 as Q,e as b,_ as D}from"./index-daaabc4f.js";import{u as h}from"./use-key-composition-88659357.js";function F(){const c=r(null),e=r(null),l=r(null),u=r(!1);async function a(){c.value=await navigator.mediaDevices.getUserMedia({audio:!0}),e.value=new MediaRecorder(c.value,{audioBitsPerSecond:128e3}),e.value.onstart=()=>u.value=!u.value,e.value.onstop=()=>u.value=!u.value,e.value.ondataavailable=n=>{l.value=new File([n.data],"audio.ogg")},e.value.start()}function i(){var n,v,g;(n=e.value)==null||n.stop(),l.value=null,(g=(v=c.value)==null?void 0:v.getTracks().at(0))==null||g.stop()}return{mediaRecorder:e,isRecording:u,voiceMessage:l,startRecording:a,stopRecording:i}}const $={key:0},L={key:1},N={key:2,class:"recording"},T=A({__name:"MessangerInput",setup(c){const e=B(),l=r(""),u=r(null),a=r(null),{voiceMessage:i,isRecording:n,startRecording:v,stopRecording:g}=F(),{f:w,data:x,loading:M}=h({fn:()=>C.saveMessage(e.currentChatId,l.value)}),{f:I,data:S,loading:k}=h({fn:()=>C.saveAudioMessage(a.value,e.currentChatId)});return f(i,()=>{i.value&&(a.value=new FormData,a.value.append("audio",i.value))}),f([x,S],(t,s)=>{t[0]&&t[0]!==s[0]&&(e.currentChat.messages.push(t[0]),e.currentChat.updatedAt=t[0].createdAt,l.value=""),t[1]&&t[1]!==s[1]&&(e.currentChat.messages.push(t[1]),e.currentChat.updatedAt=t[1].createdAt,a.value=null)}),f(n,()=>{var t;(t=u.value)==null||t.blur()}),f(a,()=>{console.log(a.value),console.log(Boolean(a.value))}),(t,s)=>(d(),y(V,{class:"input",modelValue:l.value,"onUpdate:modelValue":s[3]||(s[3]=p=>l.value=p),ref_key:"inputRef",ref:u,outlined:"","label-slot":"",loading:o(M)||o(k),readonly:o(n),"bottom-slots":""},{label:R(()=>[a.value?(d(),_("div",$,"Записано голосовое сообщение")):o(n)?(d(),_("div",N,"Идет запись... ")):(d(),_("div",L,"Написать сообщение"))]),append:R(()=>[a.value?(d(),y(m,{key:0,dense:"",round:"",flat:"",icon:"stop_circle",color:"red",onClick:s[0]||(s[0]=p=>a.value=null)})):Q("",!0),b(m,{dense:"",round:"",flat:"",icon:o(n)?"mic_off":"mic",onClick:s[1]||(s[1]=p=>o(n)?o(g)():o(v)())},null,8,["icon"]),b(m,{dense:"",round:"",flat:"",icon:"send",disable:o(M)||o(k),onClick:s[2]||(s[2]=p=>a.value?o(I)():o(w)())},null,8,["disable"])]),_:1},8,["modelValue","loading","readonly"]))}});const P=D(T,[["__scopeId","data-v-de224a4c"]]);export{P as M};
